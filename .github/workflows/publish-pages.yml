name: Publicar no GitHub Pages

on:
  workflow_dispatch:
    inputs:
      repositorio:
        description: 'Reposit√≥rio (formato: owner/repo)'
        required: true
        default: 'caelum/springnarus'
      data_inicio:
        description: 'Data de in√≠cio (YYYY-MM-DD)'
        required: true
        default: '2025-01-01'
      data_fim:
        description: 'Data de fim (YYYY-MM-DD)'
        required: true
        default: '2025-12-31'
      branch_base:
        description: 'Branch base'
        required: false
        default: 'main'
  schedule:
    # Executa toda segunda-feira √†s 8h UTC (5h hor√°rio de Bras√≠lia)
    - cron: '0 8 * * 1'
  push:
    branches:
      - main
      - master
    paths:
      - 'config/autores.txt'
      - '.github/workflows/publish-pages.yml'
      - 'docs/index.html'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pages: write
      id-token: write
    
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4
      
      - name: Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Instalar depend√™ncias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Buscar PRs do time e gerar HTML
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PERSONAL_TOKEN || secrets.GITHUB_TOKEN }}
          REPOSITORIO: ${{ github.event.inputs.repositorio || 'caelum/springnarus' }}
          DATA_INICIO: ${{ github.event.inputs.data_inicio || '2025-01-01' }}
          DATA_FIM: ${{ github.event.inputs.data_fim || '2025-12-31' }}
          BRANCH_BASE: ${{ github.event.inputs.branch_base || 'main' }}
          PYTHONPATH: ${{ github.workspace }}
        run: |
          # Se n√£o h√° config/autores.txt, cria um exemplo
          mkdir -p config
          if [ ! -f config/autores.txt ]; then
            echo "# Adicione um autor por linha" > config/autores.txt
            echo "# Exemplo:" >> config/autores.txt
            echo "# felipesalmazo" >> config/autores.txt
          fi
          
          # Cria diret√≥rio docs se n√£o existir
          mkdir -p docs
          
          # Verifica se j√° existe um HTML com dados (mais de 5000 caracteres indica que tem conte√∫do)
          if [ -f docs/index.html ] && [ $(wc -c < docs/index.html) -gt 5000 ]; then
            echo "‚úÖ HTML existente encontrado com dados. Mantendo o arquivo atual."
            echo "   Para regenerar, remova o arquivo docs/index.html antes de executar o workflow."
          else
            echo "üîÑ Gerando novo HTML..."
            # Gera HTML diretamente
            python busca_prs_time.py \
              --repositorio "$REPOSITORIO" \
              --data-inicio "$DATA_INICIO" \
              --data-fim "$DATA_FIM" \
              --branch-base "$BRANCH_BASE" \
              --gerar-html \
              --arquivo-html docs/index.html || true
            
            # Se n√£o gerou HTML, cria p√°gina de exemplo
            if [ ! -f docs/index.html ]; then
              echo "‚ö†Ô∏è HTML n√£o foi gerado. Criando p√°gina de exemplo."
              cat > docs/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="pt-BR">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>An√°lise de Entregas do Time</title>
              <style>
                  body {
                      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                      max-width: 800px;
                      margin: 50px auto;
                      padding: 20px;
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      min-height: 100vh;
                  }
                  .container {
                      background: white;
                      padding: 40px;
                      border-radius: 20px;
                      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                  }
                  h1 { color: #667eea; }
                  p { line-height: 1.6; color: #666; }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>üìä Entregas do Time</h1>
                  <p>Execute o workflow manualmente ou configure um schedule para gerar os dados.</p>
                  <p>Veja o README para mais informa√ß√µes.</p>
              </div>
          </body>
          </html>
          EOF
            fi
          fi
      
      - name: Configurar Pages
        uses: actions/configure-pages@v4
        with:
          enablement: true
      
      - name: Fazer upload do artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './docs'
      
      - name: Publicar no GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

